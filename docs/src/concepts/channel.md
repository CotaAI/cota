# Channelï¼ˆé€šä¿¡é€šé“ï¼‰

åœ¨COTAæ¡†æ¶ä¸­ï¼ŒChannelæ˜¯ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œè´Ÿè´£å°†Agentä¸å¤–éƒ¨é€šä¿¡å¹³å°æˆ–æ¸ é“è¿æ¥èµ·æ¥ï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥é€šè¿‡è¿™äº›å¹³å°ä¸æ™ºèƒ½ä½“è¿›è¡Œäº¤äº’ã€‚Channelä½œä¸ºAgentä¸ç”¨æˆ·ä¹‹é—´çš„æ¡¥æ¢ï¼Œå¤„ç†æ¶ˆæ¯çš„æ¥æ”¶ã€è½¬æ¢å’Œå‘é€ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æ¶ˆæ¯ä¼ é€’
- **æ¥æ”¶ç”¨æˆ·è¾“å…¥**: ä»å„ç§å®¢æˆ·ç«¯æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯
- **åè®®è½¬æ¢**: å°†ä¸åŒåè®®çš„æ¶ˆæ¯è½¬æ¢ä¸ºç»Ÿä¸€çš„Messageæ ¼å¼
- **å“åº”åˆ†å‘**: å°†Agentçš„å“åº”æŒ‰ç…§å¯¹åº”åè®®å‘é€ç»™ç”¨æˆ·

### 2. å¤šåè®®æ”¯æŒ
ä¸åŒçš„Channelä½¿ç”¨ä¸åŒçš„æ¶ˆæ¯ä¼ é€’åè®®ï¼š
- **SSEï¼ˆServer-Sent Eventsï¼‰**: åŸºäºHTTPåè®®çš„å•å‘æ¨é€
- **WebSocket**: åŒå‘å®æ—¶é€šä¿¡åè®®
- **SocketIO**: å¢å¼ºç‰ˆWebSocketï¼Œæ”¯æŒè‡ªåŠ¨é‡è¿ç­‰ç‰¹æ€§
- **Redis**: åŸºäºRedisçš„æ¶ˆæ¯é˜Ÿåˆ—é€šé“

### 3. å¼€å‘æµ‹è¯•æ”¯æŒ
- **å‘½ä»¤è¡ŒChannel**: ä¸ºå¼€å‘è€…æä¾›å¿«é€Ÿæµ‹è¯•ç¯å¢ƒ
- **ç›´æ¥äº¤äº’**: æ— éœ€å¤æ‚é›†æˆå³å¯éªŒè¯AgentåŠŸèƒ½
- **è°ƒè¯•å‹å¥½**: ä¾¿äºå¼€å‘é˜¶æ®µçš„åŠŸèƒ½è°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

## ğŸ”§ Channelé…ç½®

Channelé€šè¿‡`endpoints.yml`è¿›è¡Œé…ç½®ï¼Œæ”¯æŒå¤šç§é€šä¿¡åè®®ï¼š

### Redis Channelï¼ˆæ¨èï¼‰
```yaml
# endpoints.yml
channel:
  type: redis
  host: localhost        # RedisæœåŠ¡å™¨åœ°å€
  port: 6379            # Redisç«¯å£
  db: 0                 # Redisæ•°æ®åº“ç¼–å·
  password: "your_password"  # Rediså¯†ç ï¼ˆå¯é€‰ï¼‰
  
  # é«˜çº§é…ç½®
  max_connections: 20   # æœ€å¤§è¿æ¥æ•°
  connection_timeout: 10 # è¿æ¥è¶…æ—¶æ—¶é—´
  retry_attempts: 3     # é‡è¯•æ¬¡æ•°
```

### WebSocket Channel
```yaml
channel:
  type: websocket
  host: 0.0.0.0         # ç›‘å¬åœ°å€
  port: 8080            # ç›‘å¬ç«¯å£
  path: /ws             # WebSocketè·¯å¾„
  
  # CORSé…ç½®
  allow_origins: ["*"]  # å…è®¸çš„æ¥æº
  allow_methods: ["GET", "POST"]
  allow_headers: ["*"]
```

### SocketIO Channel  
```yaml
channel:
  type: socketio
  host: 0.0.0.0
  port: 8080
  
  # SocketIOç‰¹å®šé…ç½®
  namespace: /cota      # å‘½åç©ºé—´
  room_support: true    # å¯ç”¨æˆ¿é—´æ”¯æŒ
  binary_support: true  # æ”¯æŒäºŒè¿›åˆ¶æ•°æ®
```

### SSE Channel
```yaml
channel:
  type: sse
  host: 0.0.0.0
  port: 8080
  endpoint: /events     # SSEç«¯ç‚¹è·¯å¾„
  
  # æ¨é€é…ç½®
  heartbeat_interval: 30  # å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
  retry_timeout: 5000     # å®¢æˆ·ç«¯é‡è¯•è¶…æ—¶
```

### å‘½ä»¤è¡ŒChannel
```yaml
channel:
  type: cmdline
  
  # å¯é€‰é…ç½®
  prompt: "ç”¨æˆ·: "      # è¾“å…¥æç¤ºç¬¦
  encoding: utf-8       # å­—ç¬¦ç¼–ç 
  history_size: 100     # å†å²è®°å½•æ¡æ•°
```

## ğŸ“‹ Channelç±»å‹è¯¦è§£

### ğŸ”´ Redis Channel
- **æè¿°**: åŸºäºRedisçš„å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—é€šé“ï¼Œæ”¯æŒé«˜å¹¶å‘å’Œæ¶ˆæ¯æŒä¹…åŒ–
- **ä½¿ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒæ¨èï¼Œæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²å’Œè´Ÿè½½å‡è¡¡
- **ç‰¹ç‚¹**: 
  - é«˜æ€§èƒ½å¼‚æ­¥å¤„ç†
  - æ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–
  - å¤©ç„¶æ”¯æŒé›†ç¾¤éƒ¨ç½²
  - ä¼šè¯çŠ¶æ€ç®¡ç†

### ğŸŸ  WebSocket Channel
- **æè¿°**: åŸºäºæ ‡å‡†WebSocketåè®®çš„åŒå‘å®æ—¶é€šä¿¡é€šé“
- **ä½¿ç”¨åœºæ™¯**: éœ€è¦å®æ—¶äº¤äº’çš„Webåº”ç”¨ã€ç§»åŠ¨åº”ç”¨
- **ç‰¹ç‚¹**:
  - ä½å»¶è¿ŸåŒå‘é€šä¿¡
  - æ ‡å‡†åè®®å…¼å®¹æ€§å¥½
  - æ”¯æŒæ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®
  - è¿æ¥çŠ¶æ€ç®¡ç†

### ğŸŸ¡ SocketIO Channel
- **æè¿°**: åŸºäºSocket.IOåº“çš„å¢å¼ºç‰ˆWebSocketé€šé“
- **ä½¿ç”¨åœºæ™¯**: éœ€è¦é«˜çº§WebSocketç‰¹æ€§çš„å¤æ‚åº”ç”¨
- **ç‰¹ç‚¹**:
  - è‡ªåŠ¨é‡è¿æœºåˆ¶
  - æˆ¿é—´å’Œå‘½åç©ºé—´æ”¯æŒ
  - äº‹ä»¶é©±åŠ¨æ¶æ„
  - æ›´å¥½çš„æµè§ˆå™¨å…¼å®¹æ€§

### ğŸŸ¢ SSE Channel
- **æè¿°**: åŸºäºServer-Sent Eventsçš„å•å‘æ¨é€é€šé“
- **ä½¿ç”¨åœºæ™¯**: æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€å®æ—¶æ•°æ®ï¼Œå¦‚é€šçŸ¥ã€çŠ¶æ€æ›´æ–°
- **ç‰¹ç‚¹**:
  - HTTPåè®®åŸºç¡€ï¼Œç®€å•å¯é 
  - è‡ªåŠ¨é‡è¿æ”¯æŒ
  - è¾ƒä½çš„èµ„æºæ¶ˆè€—
  - é€‚åˆå•å‘æ•°æ®æ¨é€

### ğŸ”µ å‘½ä»¤è¡ŒChannel
- **æè¿°**: åŸºäºå‘½ä»¤è¡Œæ¥å£çš„äº¤äº’é€šé“
- **ä½¿ç”¨åœºæ™¯**: å¼€å‘æµ‹è¯•ã€è°ƒè¯•éªŒè¯ã€è„šæœ¬è‡ªåŠ¨åŒ–
- **ç‰¹ç‚¹**:
  - é›¶é…ç½®å¿«é€Ÿå¯åŠ¨
  - å¼€å‘è°ƒè¯•å‹å¥½
  - æ”¯æŒäº¤äº’å†å²
  - é€‚åˆè‡ªåŠ¨åŒ–è„šæœ¬

## ğŸ”„ æ¶ˆæ¯å¤„ç†æµç¨‹

### 1. æ¶ˆæ¯æ¥æ”¶æµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ Channel â†’ åè®®è§£æ â†’ Messageå¯¹è±¡ â†’ Agentå¤„ç†
```

### 2. å“åº”å‘é€æµç¨‹  
```
Agentå“åº” â†’ Messageå¯¹è±¡ â†’ åè®®å°è£… â†’ Channel â†’ ç”¨æˆ·æ¥æ”¶
```

### 3. Messageæ ¼å¼
Channelç»Ÿä¸€ä½¿ç”¨æ ‡å‡†Messageæ ¼å¼ï¼š
```json
{
  "sender": "user",
  "sender_id": "user_123", 
  "receiver": "bot",
  "receiver_id": "agent_456",
  "session_id": "session_789",
  "text": "ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬",
  "metadata": {}
}
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨Redis Channel Agent
```bash
# ç¡®ä¿RedisæœåŠ¡è¿è¡Œ
redis-server

# å¯åŠ¨Agent
cota run --agent-path ./weather --debug
```

### å¯åŠ¨WebSocket Channel Agent
```bash
# é…ç½®WebSocket Channelåå¯åŠ¨
cota run --agent-path ./weather --channel websocket
```

### å‘½ä»¤è¡Œæµ‹è¯•
```bash
# ä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œå¿«é€Ÿæµ‹è¯•
cota shell --agent-path ./weather --debug
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. Redis Channelä¼˜åŒ–
```yaml
channel:
  type: redis
  host: localhost
  port: 6379
  
  # è¿æ¥æ± é…ç½®
  max_connections: 50
  min_connections: 5
  
  # æ€§èƒ½ä¼˜åŒ–
  socket_keepalive: true
  socket_keepalive_options:
    TCP_KEEPINTVL: 1
    TCP_KEEPCNT: 3
    TCP_KEEPIDLE: 1
```

### 2. WebSocketä¼˜åŒ–
```yaml
channel:
  type: websocket
  
  # å¹¶å‘é…ç½®
  max_connections: 1000
  
  # ç¼“å†²åŒºè®¾ç½®
  read_buffer_size: 4096
  write_buffer_size: 4096
  
  # è¶…æ—¶è®¾ç½®
  ping_interval: 30
  ping_timeout: 10
```

## ğŸ› ï¸ æœ€ä½³å®è·µ

### 1. Channelé€‰æ‹©æŒ‡å—
- **ç”Ÿäº§ç¯å¢ƒ**: æ¨èRedis Channelï¼Œç¨³å®šå¯é ï¼Œæ”¯æŒé›†ç¾¤
- **å®æ—¶åº”ç”¨**: é€‰æ‹©WebSocketæˆ–SocketIO Channel
- **å•å‘æ¨é€**: ä½¿ç”¨SSE Channelï¼Œèµ„æºæ¶ˆè€—ä½
- **å¼€å‘æµ‹è¯•**: ä½¿ç”¨å‘½ä»¤è¡ŒChannelï¼Œå¿«é€ŸéªŒè¯

### 2. å®‰å…¨é…ç½®
```yaml
# WebSocketå®‰å…¨é…ç½®
channel:
  type: websocket
  
  # CORSè®¾ç½®
  allow_origins: ["https://yourdomain.com"]
  
  # è®¤è¯é…ç½®
  require_auth: true
  auth_header: "Authorization"
  
  # é™æµé…ç½®
  rate_limit: 100  # æ¯åˆ†é’Ÿæœ€å¤§æ¶ˆæ¯æ•°
```

### 3. ç›‘æ§å’Œæ—¥å¿—
```python
# å¯ç”¨Channelè°ƒè¯•æ—¥å¿—
import logging
logging.getLogger('cota.channels').setLevel(logging.DEBUG)

# ç›‘æ§æŒ‡æ ‡
- è¿æ¥æ•°
- æ¶ˆæ¯ååé‡
- å“åº”æ—¶é—´
- é”™è¯¯ç‡
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **Redisè¿æ¥å¤±è´¥**
   - æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥å‚æ•°å’Œå¯†ç 
   - ç¡®è®¤ç½‘ç»œè¿é€šæ€§

2. **WebSocketè¿æ¥æ–­å¼€**
   - æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§
   - è°ƒæ•´å¿ƒè·³é—´éš”
   - é…ç½®è‡ªåŠ¨é‡è¿

3. **æ¶ˆæ¯ä¸¢å¤±**
   - å¯ç”¨æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
   - æ£€æŸ¥ç½‘ç»œè´¨é‡
   - é…ç½®æ¶ˆæ¯æŒä¹…åŒ–

4. **æ€§èƒ½é—®é¢˜**
   - è°ƒæ•´è¿æ¥æ± å¤§å°
   - ä¼˜åŒ–æ¶ˆæ¯å¤„ç†é€»è¾‘
   - å¯ç”¨ç¼“å­˜æœºåˆ¶

é€šè¿‡åˆç†é€‰æ‹©å’Œé…ç½®Channelï¼Œå¯ä»¥ç¡®ä¿Agentä¸ç”¨æˆ·ä¹‹é—´çš„ç¨³å®šã€é«˜æ•ˆé€šä¿¡ï¼Œä¸ºç”¨æˆ·æä¾›ä¼˜è´¨çš„äº¤äº’ä½“éªŒã€‚
